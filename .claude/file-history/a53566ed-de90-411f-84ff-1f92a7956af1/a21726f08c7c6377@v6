unit uCopilotPanel;

interface

uses
   Winapi.Windows,
   Winapi.Messages,
   System.SysUtils,
   System.Classes,
   System.JSON,
   System.Generics.Collections,
   System.Threading,
   Vcl.Graphics,
   Vcl.Controls,
   Vcl.Forms,
   Vcl.StdCtrls,
   Vcl.ExtCtrls,
   Vcl.ComCtrls,
   uCopilotAPI,
   uCopilotConfig;

type
   TChatMessage = record
      IsUser: Boolean;
      Text: string;
      Timestamp: TDateTime;
   end;

   TFrmCopilotPanel = class(TForm)
      pnlHeader: TPanel;
      lblTitle: TLabel;
      btnClose: TButton;
      btnMinimize: TButton;
      btnRefresh: TButton;
      pnlChat: TPanel;
      memoChat: TRichEdit;
      pnlInput: TPanel;
      edtMessage: TEdit;
      btnSend: TButton;
      pnlSuggestions: TPanel;
      lblSuggestions: TLabel;
      pnlSuggestionsContent: TScrollBox;
      pnlAlerts: TPanel;
      lblAlerts: TLabel;
      pnlAlertsContent: TScrollBox;
      tmrAnimShow: TTimer;
      tmrAnimHide: TTimer;
      procedure FormCreate(Sender: TObject);
      procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
      procedure btnCloseClick(Sender: TObject);
      procedure btnMinimizeClick(Sender: TObject);
      procedure btnRefreshClick(Sender: TObject);
      procedure btnSendClick(Sender: TObject);
      procedure edtMessageKeyPress(Sender: TObject; var Key: Char);
      procedure tmrAnimShowTimer(Sender: TObject);
      procedure tmrAnimHideTimer(Sender: TObject);
      procedure pnlHeaderMouseDown(Sender: TObject; Button: TMouseButton;
         Shift: TShiftState; X, Y: Integer);
   private
      FMessages: TArray<TChatMessage>;
      FTargetLeft: Integer;
      FAnimating: Boolean;
      procedure AddMessage(const AText: string; AIsUser: Boolean);
      procedure UpdateChatDisplay;
      procedure DoSendMessage;
      procedure ProcessResponse(const AResponse: string);
      procedure LoadSuggestions;
      procedure LoadAlerts;
      procedure CreateSuggestionButton(const AText: string; AIndex: Integer);
      procedure CreateAlertLabel(const AText: string; AAlertType: string);
      procedure OnSuggestionClick(Sender: TObject);
      procedure PositionPanel;
   public
      procedure ShowPanel;
      procedure HidePanel;
      procedure SetContext(const AClienteID: Integer; const AVendaID: Integer);
   end;

var
   FrmCopilotPanel: TFrmCopilotPanel;

implementation

uses
   uCopilotIcon;

{$R *.dfm}

const
   PANEL_WIDTH = 380;
   PANEL_MARGIN = 10;
   ANIM_STEP = 40;

procedure TFrmCopilotPanel.FormCreate(Sender: TObject);
begin
   // Configura janela
   BorderStyle := bsNone;
   FormStyle := fsStayOnTop;
   Width := PANEL_WIDTH;
   Height := Screen.WorkAreaHeight - (PANEL_MARGIN * 2);
   AlphaBlend := True;
   AlphaBlendValue := 245;

   // Posiciona fora da tela (para animacao)
   PositionPanel;
   Left := Screen.WorkAreaWidth;
   FTargetLeft := Screen.WorkAreaWidth - Width - PANEL_MARGIN;
   FAnimating := False;

   // Inicializa
   SetLength(FMessages, 0);

   // Mensagem inicial
   AddMessage('Ola! Sou o PharmaCopilot, seu assistente de vendas. ' +
      'Como posso ajudar?', False);
end;

procedure TFrmCopilotPanel.PositionPanel;
begin
   Top := PANEL_MARGIN;
   FTargetLeft := Screen.WorkAreaWidth - Width - PANEL_MARGIN;
end;

procedure TFrmCopilotPanel.FormKeyDown(Sender: TObject; var Key: Word;
   Shift: TShiftState);
begin
   if Key = VK_ESCAPE then
   begin
      HidePanel;
   end;
end;

procedure TFrmCopilotPanel.ShowPanel;
begin
   if FAnimating then
   begin
      Exit;
   end;

   PositionPanel;
   Left := Screen.WorkAreaWidth;
   Show;
   BringToFront;

   // Inicia animacao de entrada
   FAnimating := True;
   tmrAnimShow.Enabled := True;

   // Foca no campo de mensagem
   if edtMessage.CanFocus then
   begin
      edtMessage.SetFocus;
   end;

   // Carrega sugestoes e alertas
   LoadSuggestions;
   LoadAlerts;
end;

procedure TFrmCopilotPanel.HidePanel;
begin
   if FAnimating then
   begin
      Exit;
   end;

   FAnimating := True;
   tmrAnimHide.Enabled := True;
end;

procedure TFrmCopilotPanel.tmrAnimShowTimer(Sender: TObject);
begin
   if Left > FTargetLeft then
   begin
      Left := Left - ANIM_STEP;
      if Left < FTargetLeft then
      begin
         Left := FTargetLeft;
      end;
   end
   else
   begin
      tmrAnimShow.Enabled := False;
      FAnimating := False;
   end;
end;

procedure TFrmCopilotPanel.tmrAnimHideTimer(Sender: TObject);
begin
   if Left < Screen.WorkAreaWidth then
   begin
      Left := Left + ANIM_STEP;
   end
   else
   begin
      tmrAnimHide.Enabled := False;
      FAnimating := False;
      Hide;
   end;
end;

procedure TFrmCopilotPanel.btnCloseClick(Sender: TObject);
begin
   HidePanel;
end;

procedure TFrmCopilotPanel.btnMinimizeClick(Sender: TObject);
begin
   HidePanel;
end;

procedure TFrmCopilotPanel.btnRefreshClick(Sender: TObject);
begin
   // Forca atualizacao de sugestoes e alertas
   AddMessage(Format('Atualizando... (VendaID=%d, ClienteID=%d)',
      [CopilotAPI.VendaID, CopilotAPI.ClienteID]), False);
   LoadSuggestions;
   LoadAlerts;
end;

procedure TFrmCopilotPanel.pnlHeaderMouseDown(Sender: TObject;
   Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
   // Permite arrastar pelo header
   if Button = mbLeft then
   begin
      ReleaseCapture;
      Winapi.Windows.SendMessage(Handle, WM_NCLBUTTONDOWN, HTCAPTION, 0);
   end;
end;

procedure TFrmCopilotPanel.AddMessage(const AText: string; AIsUser: Boolean);
var
   Msg: TChatMessage;
begin
   Msg.IsUser := AIsUser;
   Msg.Text := AText;
   Msg.Timestamp := Now;

   SetLength(FMessages, Length(FMessages) + 1);
   FMessages[High(FMessages)] := Msg;

   UpdateChatDisplay;
end;

procedure TFrmCopilotPanel.UpdateChatDisplay;
var
   I: Integer;
   Msg: TChatMessage;
   Prefix: string;
begin
   memoChat.Clear;

   for I := 0 to High(FMessages) do
   begin
      Msg := FMessages[I];

      if Msg.IsUser then
      begin
         Prefix := 'Voce: ';
         memoChat.SelAttributes.Color := clNavy;
         memoChat.SelAttributes.Style := [fsBold];
      end
      else
      begin
         Prefix := 'Copilot: ';
         memoChat.SelAttributes.Color := clGreen;
         memoChat.SelAttributes.Style := [fsBold];
      end;

      memoChat.SelText := Prefix;
      memoChat.SelAttributes.Color := clBlack;
      memoChat.SelAttributes.Style := [];
      memoChat.SelText := Msg.Text + #13#10#13#10;
   end;

   // Scroll para o final
   Winapi.Windows.SendMessage(memoChat.Handle, WM_VSCROLL, SB_BOTTOM, 0);
end;

procedure TFrmCopilotPanel.edtMessageKeyPress(Sender: TObject; var Key: Char);
begin
   if Key = #13 then
   begin
      Key := #0;
      DoSendMessage;
   end;
end;

procedure TFrmCopilotPanel.btnSendClick(Sender: TObject);
begin
   DoSendMessage;
end;

procedure TFrmCopilotPanel.DoSendMessage;
var
   UserMessage: string;
begin
   UserMessage := Trim(edtMessage.Text);
   if UserMessage = '' then
   begin
      Exit;
   end;

   // Adiciona mensagem do usuario
   AddMessage(UserMessage, True);
   edtMessage.Clear;

   // Desabilita input enquanto processa
   edtMessage.Enabled := False;
   btnSend.Enabled := False;

   // Envia para o backend em thread separada
   TTask.Run(
      procedure
      var
         Response: string;
      begin
         try
            Response := CopilotAPI.SendChatMessage(UserMessage);

            TThread.Synchronize(nil,
               procedure
               begin
                  ProcessResponse(Response);
                  edtMessage.Enabled := True;
                  btnSend.Enabled := True;
                  edtMessage.SetFocus;
               end
            );
         except
            on E: Exception do
            begin
               TThread.Synchronize(nil,
                  procedure
                  begin
                     AddMessage('Erro ao conectar com o servidor: ' + E.Message, False);
                     edtMessage.Enabled := True;
                     btnSend.Enabled := True;
                  end
               );
            end;
         end;
      end
   );
end;

procedure TFrmCopilotPanel.ProcessResponse(const AResponse: string);
var
   JSON: TJSONObject;
   ResponseText: string;
   Suggestions: TJSONArray;
   I: Integer;
begin
   try
      JSON := TJSONObject.ParseJSONValue(AResponse) as TJSONObject;
      try
         if Assigned(JSON) then
         begin
            ResponseText := JSON.GetValue<string>('message', '');
            AddMessage(ResponseText, False);

            // Atualiza sugestoes se vierem na resposta
            if JSON.TryGetValue<TJSONArray>('suggestions', Suggestions) then
            begin
               // Limpa sugestoes anteriores
               while pnlSuggestionsContent.ControlCount > 0 do
               begin
                  pnlSuggestionsContent.Controls[0].Free;
               end;

               // Adiciona novas
               for I := 0 to Suggestions.Count - 1 do
               begin
                  CreateSuggestionButton(Suggestions.Items[I].Value, I);
               end;
            end;
         end
         else
         begin
            AddMessage('Resposta invalida do servidor.', False);
         end;
      finally
         JSON.Free;
      end;
   except
      on E: Exception do
      begin
         AddMessage('Erro ao processar resposta: ' + E.Message, False);
      end;
   end;
end;

procedure TFrmCopilotPanel.LoadSuggestions;
begin
   // Carrega sugestoes do backend em thread separada
   TTask.Run(
      procedure
      var
         Response: string;
         JSON: TJSONArray;
         Item, ProdutoObj: TJSONObject;
         Tipo, Motivo, ProdutoNome, TextoSugestao: string;
      begin
         try
            Response := CopilotAPI.GetSuggestions;

            TThread.Synchronize(nil,
               procedure
               begin
                  try
                     // Limpa sugestoes anteriores
                     while pnlSuggestionsContent.ControlCount > 0 do
                     begin
                        pnlSuggestionsContent.Controls[0].Free;
                     end;

                     JSON := TJSONObject.ParseJSONValue(Response) as TJSONArray;
                     if Assigned(JSON) then
                     begin
                        try
                           for var I := 0 to JSON.Count - 1 do
                           begin
                              Item := JSON.Items[I] as TJSONObject;

                              // Extrai campos do schema Suggestion
                              Tipo := Item.GetValue<string>('tipo', '');
                              Motivo := Item.GetValue<string>('motivo', '');
                              ProdutoNome := '';

                              // Produto e um objeto aninhado
                              if Item.TryGetValue<TJSONObject>('produto', ProdutoObj) then
                              begin
                                 ProdutoNome := ProdutoObj.GetValue<string>('nome', '');
                              end;

                              // Monta texto para exibir
                              if ProdutoNome <> '' then
                              begin
                                 TextoSugestao := ProdutoNome;
                                 if Motivo <> '' then
                                 begin
                                    TextoSugestao := TextoSugestao + ' - ' + Motivo;
                                 end;
                              end
                              else
                              begin
                                 TextoSugestao := Motivo;
                              end;

                              if TextoSugestao <> '' then
                              begin
                                 CreateSuggestionButton(TextoSugestao, I);
                              end;
                           end;

                           // Feedback no chat
                           if JSON.Count > 0 then
                           begin
                              AddMessage(Format('%d sugestao(oes) carregada(s)', [JSON.Count]), False);
                           end
                           else
                           begin
                              AddMessage('Nenhuma sugestao disponivel no momento.', False);
                           end;
                        finally
                           JSON.Free;
                        end;
                     end
                     else
                     begin
                        AddMessage('Resposta vazia do servidor de sugestoes.', False);
                     end;
                  except
                     on E: Exception do
                     begin
                        AddMessage('Erro ao carregar sugestoes: ' + E.Message, False);
                     end;
                  end;
               end
            );
         except
            // Silencioso
         end;
      end);
end;

procedure TFrmCopilotPanel.LoadAlerts;
begin
   // Carrega alertas do backend em thread separada
   TTask.Run(
      procedure
      var
         Response: string;
         JSON: TJSONArray;
         Item: TJSONObject;
         Titulo, Mensagem, Severidade, TextoAlerta: string;
      begin
         try
            Response := CopilotAPI.GetAlerts;

            TThread.Synchronize(nil,
               procedure
               begin
                  try
                     // Limpa alertas anteriores
                     while pnlAlertsContent.ControlCount > 0 do
                     begin
                        pnlAlertsContent.Controls[0].Free;
                     end;

                     JSON := TJSONObject.ParseJSONValue(Response) as TJSONArray;
                     if Assigned(JSON) then
                     begin
                        try
                           for var I := 0 to JSON.Count - 1 do
                           begin
                              Item := JSON.Items[I] as TJSONObject;

                              // Extrai campos do schema Alert
                              Titulo := Item.GetValue<string>('titulo', '');
                              Mensagem := Item.GetValue<string>('mensagem', '');
                              Severidade := Item.GetValue<string>('severidade', 'info');

                              // Monta texto - Titulo: Mensagem
                              if Titulo <> '' then
                              begin
                                 TextoAlerta := Titulo;
                                 if Mensagem <> '' then
                                 begin
                                    TextoAlerta := TextoAlerta + ': ' + Mensagem;
                                 end;
                              end
                              else
                              begin
                                 TextoAlerta := Mensagem;
                              end;

                              if TextoAlerta <> '' then
                              begin
                                 // Converte severidade 'danger' para 'error' usado no CreateAlertLabel
                                 if Severidade = 'danger' then
                                 begin
                                    Severidade := 'error';
                                 end;
                                 CreateAlertLabel(TextoAlerta, Severidade);
                              end;
                           end;

                           // Mostra notificacao se houver alertas
                           if (JSON.Count > 0) and Assigned(FrmCopilotIcon) then
                           begin
                              FrmCopilotIcon.ShowNotification(
                                 'PharmaCopilot',
                                 IntToStr(JSON.Count) + ' alerta(s) ativo(s)'
                              );
                           end;
                        finally
                           JSON.Free;
                        end;
                     end;
                  except
                     // Silencioso
                  end;
               end
            );
         except
            // Silencioso
         end;
      end
   );
end;

procedure TFrmCopilotPanel.CreateSuggestionButton(const AText: string;
   AIndex: Integer);
var
   Btn: TButton;
begin
   Btn := TButton.Create(pnlSuggestionsContent);
   Btn.Parent := pnlSuggestionsContent;
   Btn.Caption := AText;
   Btn.Tag := AIndex;
   Btn.Left := 5;
   Btn.Top := 5 + (AIndex * 30);
   Btn.Width := pnlSuggestionsContent.Width - 10;
   Btn.Height := 25;
   Btn.OnClick := OnSuggestionClick;
end;

procedure TFrmCopilotPanel.CreateAlertLabel(const AText: string;
   AAlertType: string);
var
   Lbl: TLabel;
   Top: Integer;
begin
   Top := 5;
   if pnlAlertsContent.ControlCount > 0 then
   begin
      Top := pnlAlertsContent.Controls[pnlAlertsContent.ControlCount - 1].Top +
         pnlAlertsContent.Controls[pnlAlertsContent.ControlCount - 1].Height + 5;
   end;

   Lbl := TLabel.Create(pnlAlertsContent);
   Lbl.Parent := pnlAlertsContent;
   Lbl.Caption := '- ' + AText;
   Lbl.Left := 5;
   Lbl.Top := Top;
   Lbl.Width := pnlAlertsContent.Width - 10;
   Lbl.WordWrap := True;
   Lbl.AutoSize := True;

   // Cor baseada no tipo
   if AAlertType = 'warning' then
   begin
      Lbl.Font.Color := clOlive;
   end
   else if AAlertType = 'error' then
   begin
      Lbl.Font.Color := clMaroon;
   end
   else
   begin
      Lbl.Font.Color := clNavy;
   end;
end;

procedure TFrmCopilotPanel.OnSuggestionClick(Sender: TObject);
var
   Btn: TButton;
begin
   Btn := Sender as TButton;
   edtMessage.Text := Btn.Caption;
   DoSendMessage;
end;

procedure TFrmCopilotPanel.SetContext(const AClienteID: Integer;
   const AVendaID: Integer);
begin
   CopilotAPI.ClienteID := AClienteID;
   CopilotAPI.VendaID := AVendaID;

   // Recarrega sugestoes com novo contexto
   LoadSuggestions;
   LoadAlerts;
end;

end.
