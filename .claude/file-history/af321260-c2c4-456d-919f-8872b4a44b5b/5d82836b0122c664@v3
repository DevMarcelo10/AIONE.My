"""Popula tabela de interacoes medicamentosas para testes."""
import os
import sys

# Muda para o diretorio do backend para carregar .env corretamente
backend_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
os.chdir(backend_dir)
sys.path.insert(0, backend_dir)

from dotenv import load_dotenv
load_dotenv()

from sqlalchemy import create_engine, text
from config.settings import settings

# Interacoes conhecidas para farmacia
# Nomes EXATOS das substancias conforme cadastro no AIONE (arqsubstancia)
INTERACOES = [
    # Varfarina (Marevan) - anticoagulante, muitas interacoes
    ("VARFARINA SÓDICA", "ACIDO ACETILSALICILICO", "grave",
     "Risco aumentado de sangramento. AAS potencializa efeito anticoagulante da Varfarina.",
     "Evitar uso concomitante. Se necessario, monitorar INR frequentemente."),

    ("VARFARINA SÓDICA", "IBUPROFENO", "grave",
     "AINEs aumentam risco de sangramento gastrointestinal com anticoagulantes.",
     "Evitar AINEs. Se necessario, usar por menor tempo possivel e monitorar."),

    ("VARFARINA SÓDICA", "OMEPRAZOL", "moderada",
     "Omeprazol pode aumentar efeito da Varfarina por inibicao enzimatica.",
     "Monitorar INR. Considerar usar pantoprazol como alternativa."),

    # Benzodiazepinicos - DUPLICIDADE
    ("DIAZEPAM", "CLONAZEPAM", "moderada",
     "Uso de dois benzodiazepinicos aumenta risco de sedacao excessiva e depressao respiratoria.",
     "Evitar duplicidade. Revisar necessidade de ambos os medicamentos."),

    ("DIAZEPAM", "FLUOXETINA", "moderada",
     "Fluoxetina pode aumentar niveis de Diazepam por inibicao do CYP3A4.",
     "Monitorar sedacao excessiva. Considerar reducao da dose de Diazepam."),

    ("CLONAZEPAM", "FLUOXETINA", "moderada",
     "Fluoxetina pode aumentar niveis de Clonazepam por inibicao enzimatica.",
     "Monitorar sedacao excessiva. Considerar reducao da dose."),

    # IBPs - DUPLICIDADE
    ("PANTOPRAZOL SÓDICO SESQUI-HIDRATADO", "OMEPRAZOL", "leve",
     "Uso de dois inibidores de bomba de protons simultaneamente nao traz beneficio adicional.",
     "Escolher apenas um IBP. Duplicidade desnecessaria."),

    # Estatinas
    ("SINVASTATINA", "AMIODARONA", "grave",
     "Amiodarona aumenta niveis de Sinvastatina - risco de rabdomiolise.",
     "Limitar Sinvastatina a 20mg/dia. Considerar outra estatina."),

    # Mais interacoes
    ("CLOPIDOGREL", "OMEPRAZOL", "moderada",
     "Omeprazol reduz conversao de Clopidogrel em metabolito ativo.",
     "Preferir Pantoprazol que tem menor interacao."),

    ("IBUPROFENO", "ACIDO ACETILSALICILICO", "moderada",
     "Ibuprofeno pode reduzir efeito cardioprotetor do AAS e aumentar risco de sangramento.",
     "Tomar AAS pelo menos 30min antes do Ibuprofeno ou usar outro analgesico."),
]

def main():
    # Conecta ao banco copilot
    db_url = settings.COPILOT_DB_URL.replace("+aiomysql", "+pymysql")
    print(f"Conectando a: {db_url}")

    engine = create_engine(db_url, echo=True)

    with engine.connect() as conn:
        # Limpa interacoes anteriores
        conn.execute(text("DELETE FROM copilot_interacao WHERE id > 0"))
        conn.commit()
        print("Tabela limpa.")

        # Insere interacoes
        for pa1, pa2, sev, desc, rec in INTERACOES:
            # Insere nos dois sentidos para facilitar busca
            conn.execute(text("""
                INSERT INTO copilot_interacao
                (principio_ativo_1, principio_ativo_2, severidade, descricao, recomendacao, fonte)
                VALUES (:pa1, :pa2, :sev, :desc, :rec, 'manual')
            """), {"pa1": pa1, "pa2": pa2, "sev": sev, "desc": desc, "rec": rec})

            conn.execute(text("""
                INSERT INTO copilot_interacao
                (principio_ativo_1, principio_ativo_2, severidade, descricao, recomendacao, fonte)
                VALUES (:pa1, :pa2, :sev, :desc, :rec, 'manual')
            """), {"pa1": pa2, "pa2": pa1, "sev": sev, "desc": desc, "rec": rec})

        conn.commit()
        print(f"Inseridas {len(INTERACOES) * 2} interacoes.")

        # Verifica
        result = conn.execute(text("SELECT COUNT(*) as total FROM copilot_interacao"))
        row = result.fetchone()
        print(f"Total de interacoes na tabela: {row[0]}")

if __name__ == "__main__":
    main()
