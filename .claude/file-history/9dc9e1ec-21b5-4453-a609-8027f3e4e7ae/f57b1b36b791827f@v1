#!/usr/bin/env python3
"""
Teste rápido de conexão com o banco MySQL
"""

import mysql.connector
from mysql.connector import Error
import configparser
import os

# Carregar configuração
config = configparser.ConfigParser()
config.read('config.ini')

DB_CONFIG = {
    'host': config.get('Database', 'host'),
    'port': config.getint('Database', 'port'),
    'user': config.get('Database', 'user'),
    'password': config.get('Database', 'password'),
    'database': config.get('Database', 'database')
}

print("========================================")
print("  Teste de Conexão MySQL - AIONE.My")
print("========================================")
print()
print(f"Host: {DB_CONFIG['host']}")
print(f"Porta: {DB_CONFIG['port']}")
print(f"Usuário: {DB_CONFIG['user']}")
print(f"Database: {DB_CONFIG['database']}")
print()

try:
    print("Conectando ao MySQL...")
    connection = mysql.connector.connect(**DB_CONFIG)

    if connection.is_connected():
        db_info = connection.get_server_info()
        print(f"✅ CONEXÃO ESTABELECIDA!")
        print(f"   Versão do MySQL: {db_info}")

        cursor = connection.cursor()
        cursor.execute("SELECT DATABASE()")
        database = cursor.fetchone()[0]
        print(f"   Banco ativo: {database}")

        # Lista algumas tabelas
        cursor.execute("SHOW TABLES LIMIT 5")
        tables = cursor.fetchall()
        print()
        print(f"✅ Primeiras 5 tabelas encontradas:")
        for idx, table in enumerate(tables, 1):
            print(f"   {idx}. {table[0]}")

        cursor.close()
        connection.close()
        print()
        print("========================================")
        print("  TESTE CONCLUÍDO COM SUCESSO!")
        print("========================================")
        print()
        print("Próximo passo: Reinicie o Claude Code")

except Error as e:
    print(f"❌ ERRO ao conectar ao MySQL:")
    print(f"   {str(e)}")
    print()
    print("Verifique:")
    print("  1. O servidor MySQL está rodando?")
    print("  2. As credenciais em config.ini estão corretas?")
    print("  3. O servidor IAServer.exe está ativo?")
finally:
    if 'connection' in locals() and connection.is_connected():
        connection.close()
