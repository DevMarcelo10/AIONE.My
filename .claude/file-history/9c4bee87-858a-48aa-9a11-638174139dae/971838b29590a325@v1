"""
Script para atualizar o campo EAN na tabela copilot_medicamento_info
usando dados da tabela arqproduto do ERP.
"""
import os
from sqlalchemy import create_engine, text

# Conexões
ERP_DB_URL = f"mysql+pymysql://root:{os.environ.get('ERP_DB_PASSWORD', '')}@localhost:3307/dbaione"
COPILOT_DB_URL = "mysql+pymysql://root:@localhost:3306/copilot"

erp_engine = create_engine(ERP_DB_URL)
copilot_engine = create_engine(COPILOT_DB_URL)


def get_ean_por_principio(principio_ativo: str) -> str | None:
    """Busca EAN de um produto pelo princípio ativo."""
    # Normaliza o princípio ativo
    pa = principio_ativo.upper().strip()

    # Remove sufixos comuns para melhorar o match
    pa_base = pa.replace(" SODICA", "").replace(" SODICO", "")
    pa_base = pa_base.replace(" POTASSICA", "").replace(" POTASSICO", "")
    pa_base = pa_base.replace(" CLORIDRATO", "").replace(" MALEATO", "")
    pa_base = pa_base.replace(" BESILATO", "").replace(" CALCICA", "")
    pa_base = pa_base.replace(" HEMITARTARATO", "").replace(" OXALATO", "")
    pa_base = pa_base.replace(" DICLORIDRATO", "")

    with erp_engine.connect() as conn:
        # Tenta match exato primeiro
        query = text("""
            SELECT p.CodEANpri
            FROM arqproduto p
            JOIN arqprodutosub ps ON p.IDProd = ps.IDProd
            JOIN arqsubstancia s ON ps.IDSubs = s.IDSubs
            WHERE UPPER(s.DesSubs) = :pa
              AND p.CodEANpri IS NOT NULL
              AND p.CodEANpri != ''
              AND p.Ativo = 'S'
            ORDER BY p.PrecoVen DESC
            LIMIT 1
        """)
        result = conn.execute(query, {"pa": pa})
        row = result.fetchone()
        if row:
            return row[0]

        # Tenta match parcial com base
        query = text("""
            SELECT p.CodEANpri
            FROM arqproduto p
            JOIN arqprodutosub ps ON p.IDProd = ps.IDProd
            JOIN arqsubstancia s ON ps.IDSubs = s.IDSubs
            WHERE UPPER(s.DesSubs) LIKE :pa_like
              AND p.CodEANpri IS NOT NULL
              AND p.CodEANpri != ''
              AND p.Ativo = 'S'
            ORDER BY p.PrecoVen DESC
            LIMIT 1
        """)
        result = conn.execute(query, {"pa_like": f"%{pa_base}%"})
        row = result.fetchone()
        if row:
            return row[0]

    return None


def main():
    print("Atualizando EANs na tabela copilot_medicamento_info...")

    # Busca registros sem EAN
    with copilot_engine.connect() as conn:
        result = conn.execute(text(
            "SELECT id, principio_ativo FROM copilot_medicamento_info WHERE ean IS NULL"
        ))
        registros = result.fetchall()

    print(f"Encontrados {len(registros)} registros sem EAN")

    atualizados = 0
    nao_encontrados = []

    for reg_id, principio in registros:
        ean = get_ean_por_principio(principio)

        if ean:
            with copilot_engine.connect() as conn:
                conn.execute(
                    text("UPDATE copilot_medicamento_info SET ean = :ean WHERE id = :id"),
                    {"ean": ean, "id": reg_id}
                )
                conn.commit()
            atualizados += 1
            print(f"  [{atualizados}] {principio} -> {ean}")
        else:
            nao_encontrados.append(principio)

    print(f"\nResultado:")
    print(f"  - Atualizados: {atualizados}")
    print(f"  - Não encontrados: {len(nao_encontrados)}")

    if nao_encontrados:
        print(f"\nPrincípios não encontrados:")
        for pa in nao_encontrados[:20]:  # Mostra só os 20 primeiros
            print(f"  - {pa}")
        if len(nao_encontrados) > 20:
            print(f"  ... e mais {len(nao_encontrados) - 20}")


if __name__ == "__main__":
    main()
