#!/usr/bin/env python3
"""Script para descrever a estrutura de uma tabela do banco AIONE"""

import mysql.connector
from mysql.connector import Error
import sys

DB_CONFIG = {
    'host': 'localhost',
    'port': 3307,
    'user': 'root',
    'password': 'f68interdb',
    'database': 'dbaione',
    'charset': 'utf8mb4',
    'collation': 'utf8mb4_general_ci'
}

def describe_table(table_name):
    connection = None
    try:
        print(f"Conectando ao banco de dados MySQL...")
        connection = mysql.connector.connect(**DB_CONFIG)

        if connection.is_connected():
            print(f"Conectado ao banco '{DB_CONFIG['database']}' com sucesso!\n")

            cursor = connection.cursor(dictionary=True)

            # Descrever estrutura da tabela
            cursor.execute(f"DESCRIBE `{table_name}`")
            columns = cursor.fetchall()

            print("=" * 100)
            print(f"ESTRUTURA DA TABELA: {table_name}")
            print("=" * 100)
            print(f"{'Campo':<30} {'Tipo':<25} {'Nulo':<6} {'Chave':<8} {'Padrão':<15} {'Extra':<20}")
            print("-" * 100)

            for col in columns:
                field = col['Field'][:30]
                tipo = col['Type'][:25]
                null = col['Null'][:6]
                key = col['Key'][:8] if col['Key'] else ''
                default = str(col['Default'])[:15] if col['Default'] is not None else 'NULL'
                extra = col['Extra'][:20] if col['Extra'] else ''

                print(f"{field:<30} {tipo:<25} {null:<6} {key:<8} {default:<15} {extra:<20}")

            print("-" * 100)
            print(f"Total de campos: {len(columns)}\n")

            # Obter contagem de registros
            cursor.execute(f"SELECT COUNT(*) as total FROM `{table_name}`")
            count = cursor.fetchone()['total']
            print(f"Total de registros: {count:,}\n")

            # Mostrar índices
            cursor.execute(f"SHOW INDEX FROM `{table_name}`")
            indexes = cursor.fetchall()

            if indexes:
                print("=" * 100)
                print("ÍNDICES:")
                print("=" * 100)

                index_dict = {}
                for idx in indexes:
                    key_name = idx['Key_name']
                    if key_name not in index_dict:
                        index_dict[key_name] = {
                            'columns': [],
                            'unique': not idx['Non_unique'],
                            'type': idx['Index_type']
                        }
                    index_dict[key_name]['columns'].append(idx['Column_name'])

                for idx_name, idx_info in index_dict.items():
                    unique_str = "UNIQUE" if idx_info['unique'] else "INDEX"
                    cols_str = ", ".join(idx_info['columns'])
                    print(f"{unique_str:8} {idx_name:30} ({cols_str}) [{idx_info['type']}]")

                print()

            cursor.close()

    except Error as e:
        print(f"Erro ao conectar ao MySQL: {e}")
    finally:
        if connection and connection.is_connected():
            connection.close()
            print("\nConexão fechada.")

if __name__ == "__main__":
    table_name = sys.argv[1] if len(sys.argv) > 1 else "arqproduto"
    describe_table(table_name)
