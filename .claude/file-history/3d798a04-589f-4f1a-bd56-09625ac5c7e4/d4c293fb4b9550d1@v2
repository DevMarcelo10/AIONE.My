"""Endpoints de sugestões de produtos."""

from typing import Optional
from fastapi import APIRouter, HTTPException, Query
import structlog

from models.schemas import (
    Suggestion,
    SuggestionsResponse,
    StatusColor,
    SuggestionType,
)
from services.suggestion_service import SuggestionService
from routers.config import get_terminal_detector

router = APIRouter()
logger = structlog.get_logger()

suggestion_service = SuggestionService()


def get_suggestions_color(suggestions: list[Suggestion]) -> StatusColor:
    """Determina cor baseada nas sugestoes."""
    for sug in suggestions:
        if sug.tipo == SuggestionType.GENERICO and sug.economia and sug.economia > 0:
            return StatusColor.GREEN
    for sug in suggestions:
        if sug.tipo == SuggestionType.CROSS_SELL:
            return StatusColor.BLUE
    return StatusColor.GRAY


@router.get("", response_model=SuggestionsResponse)
async def get_suggestions_base(
    cliente_id: int = 0,
    venda_id: int = 0,
    filial_id: int = 1,
):
    """
    Retorna sugestoes baseadas no contexto atual.
    Endpoint base chamado pelo widget.
    """
    try:
        suggestions = []
        if venda_id > 0:
            suggestions = await suggestion_service.get_sugestoes_venda(
                venda_id,
                cliente_id if cliente_id > 0 else None
            )
        return SuggestionsResponse(
            suggestions=suggestions,
            status_color=get_suggestions_color(suggestions),
        )
    except Exception:
        return SuggestionsResponse()


@router.get("/genericos/{produto_id}", response_model=list[Suggestion])
async def get_genericos(produto_id: int):
    """
    Retorna genéricos disponíveis para um produto.

    Útil quando cliente pergunta "tem mais barato?".
    """
    try:
        return await suggestion_service.get_genericos(produto_id)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/cross-sell/{produto_id}", response_model=list[Suggestion])
async def get_cross_sell(produto_id: int):
    """
    Retorna produtos complementares (cross-sell).

    Ex: Antitérmico → Termômetro, Antialérgico → Soro fisiológico
    """
    try:
        return await suggestion_service.get_cross_sell(produto_id)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/recompra/{cliente_id}", response_model=list[Suggestion])
async def get_recompra(
    cliente_id: int,
    dias: int = Query(default=90, ge=30, le=365),
):
    """
    Retorna produtos que o cliente costuma comprar.

    Analisa histórico e sugere medicamentos de uso contínuo.
    """
    try:
        return await suggestion_service.get_recompra(cliente_id, dias)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/venda-atual/{venda_id}", response_model=list[Suggestion])
async def get_sugestoes_venda(
    venda_id: int,
    cliente_id: Optional[int] = None,
):
    """
    Retorna sugestões baseadas na venda atual.

    Combina: genéricos, cross-sell, promoções e histórico do cliente.
    """
    try:
        # Auto-detecta venda se nao informada
        if venda_id == 0:
            try:
                detector = get_terminal_detector()
                detected_venda, detected_cliente = detector.get_venda_atual()
                if detected_venda:
                    venda_id = detected_venda
                    if detected_cliente and cliente_id is None:
                        cliente_id = detected_cliente
                    logger.debug(
                        "venda_auto_detectada_suggestions",
                        venda_id=venda_id,
                        cliente_id=cliente_id
                    )
            except Exception as e:
                logger.warning("auto_detect_failed", error=str(e))

        if venda_id == 0:
            return []

        return await suggestion_service.get_sugestoes_venda(venda_id, cliente_id)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
